#!/bin/bash
# Pre-commit hook for mpm-packages
# Runs full test suite before allowing commits
#
# Install: ln -sf ../../hooks/pre-commit .git/hooks/pre-commit

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MPM_PACKAGES="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit tests...${NC}"
echo ""

# =============================================================================
# LUA UNIT TESTS
# =============================================================================

LUA_BIN="${LUA_BIN:-/opt/homebrew/bin/lua}"
if [ ! -x "$LUA_BIN" ]; then
    LUA_BIN="$(which lua5.4 2>/dev/null || which lua 2>/dev/null)"
fi

if [ -x "$LUA_BIN" ]; then
    echo -e "${YELLOW}[1/3] Lua Unit Tests${NC}"

    if ! "$LUA_BIN" "$MPM_PACKAGES/tests/lua/run.lua" "$MPM_PACKAGES" 2>&1 | tail -5; then
        echo -e "${RED}Lua tests failed!${NC}"
        exit 1
    fi
    echo ""
else
    echo -e "${YELLOW}[1/3] Lua tests skipped (no lua found)${NC}"
    echo ""
fi

# =============================================================================
# CRAFTOS-PC TESTS (Optional - skip if not installed)
# =============================================================================

CRAFTOS="/Applications/CraftOS-PC.app/Contents/MacOS/craftos"

if [ -x "$CRAFTOS" ]; then
    echo -e "${YELLOW}[2/3] CraftOS-PC Integration Tests${NC}"

    OUTPUT=$(timeout 60 "$CRAFTOS" --headless \
        --mount-ro /workspace="$MPM_PACKAGES" \
        --exec "dofile('/workspace/tests/craftos/test_runner.lua')" 2>&1 || true)

    if echo "$OUTPUT" | grep -q "TESTS FAILED"; then
        echo -e "${RED}CraftOS integration tests failed!${NC}"
        echo "$OUTPUT" | grep -E "^\[FAIL\]" | uniq | head -5
        exit 1
    fi

    PASSED=$(echo "$OUTPUT" | grep -E "^Passed:" | tail -1)
    echo "$PASSED"
    echo ""

    echo -e "${YELLOW}[3/3] CraftOS-PC Swarm Simulation${NC}"

    OUTPUT=$(timeout 120 "$CRAFTOS" --headless \
        --mount-ro /workspace="$MPM_PACKAGES" \
        --exec "dofile('/workspace/tests/craftos/swarm_simulation.lua')" 2>&1 || true)

    if echo "$OUTPUT" | grep -q "TESTS FAILED"; then
        echo -e "${RED}Swarm simulation tests failed!${NC}"
        echo "$OUTPUT" | grep -E "^\[FAIL\]" | uniq | head -5
        exit 1
    fi

    PASSED=$(echo "$OUTPUT" | grep -E "^Passed:" | tail -1)
    echo "$PASSED"
    echo ""
else
    echo -e "${YELLOW}[2/3] CraftOS tests skipped (CraftOS-PC not installed)${NC}"
    echo -e "${YELLOW}[3/3] Swarm simulation skipped${NC}"
    echo ""
fi

echo -e "${GREEN}All tests passed!${NC}"
exit 0
