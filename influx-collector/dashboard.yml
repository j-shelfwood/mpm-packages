apiVersion: influxdata.com/v2alpha1
kind: Variable
metadata:
    name: cc-telemetry-detector-generation
spec:
    description: Peripheral name of the energy detector measuring power GENERATION
    language: flux
    name: detector_generation
    query: |-
        import "influxdata/influxdb/schema"
        schema.tagValues(bucket: "mc", tag: "name", predicate: (r) => r._measurement == "energy_flow")
    type: query
---
apiVersion: influxdata.com/v2alpha1
kind: Variable
metadata:
    name: cc-telemetry-detector-consumption
spec:
    description: Peripheral name of the energy detector measuring power CONSUMPTION
    language: flux
    name: detector_consumption
    query: |-
        import "influxdata/influxdb/schema"
        schema.tagValues(bucket: "mc", tag: "name", predicate: (r) => r._measurement == "energy_flow")
    type: query
---
apiVersion: influxdata.com/v2alpha1
kind: Dashboard
metadata:
    name: cc-telemetry-dashboard
spec:
    description: Minecraft CC:Tweaked telemetry — energy, AE2, crafting, machines
    name: CC Telemetry
    charts:

        # ── Row 1: Energy headline stats (y=0, height=2) ───────────────────────

        - kind: Single_Stat
          name: Energy Stored (FE)
          height: 2
          width: 3
          xPos: 0
          yPos: 0
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_total" and r._field == "stored_fe")
                  |> last()
          decimalPlaces: 0
          suffix: " FE"
          colors:
            - hex: "#31C0F6"
              name: pool
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Energy %
          height: 2
          width: 1
          xPos: 3
          yPos: 0
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_total" and r._field == "percent")
                  |> last()
          decimalPlaces: 1
          suffix: "%"
          colors:
            - hex: "#00C9FF"
              name: laser
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Power Generation
          height: 2
          width: 2
          xPos: 4
          yPos: 0
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == v.detector_generation)
                  |> last()
          decimalPlaces: 0
          suffix: " FE/t"
          colors:
            - hex: "#4ED8A0"
              name: mint
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Power Consumption
          height: 2
          width: 2
          xPos: 6
          yPos: 0
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == v.detector_consumption)
                  |> last()
          decimalPlaces: 0
          suffix: " FE/t"
          colors:
            - hex: "#F48FB1"
              name: pink
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Net Flow
          height: 2
          width: 2
          xPos: 8
          yPos: 0
          queries:
            - query: |-
                gen = from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == v.detector_generation)
                  |> last()
                  |> map(fn: (r) => ({r with _value: r._value}))

                con = from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == v.detector_consumption)
                  |> last()
                  |> map(fn: (r) => ({r with _value: r._value}))

                join(tables: {gen: gen, con: con}, on: ["_time", "node"])
                  |> map(fn: (r) => ({r with _value: r._value_gen - r._value_con}))
          decimalPlaces: 0
          suffix: " FE/t"
          colors:
            - hex: "#FFD166"
              name: gold
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: AE Items Total
          height: 2
          width: 2
          xPos: 10
          yPos: 0
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "items_total")
                  |> last()
          decimalPlaces: 0
          colors:
            - hex: "#F48FB1"
              name: pink
              type: text
          staticLegend: {}

        # ── Row 2: AE headline stats (y=2, height=2) ───────────────────────────

        - kind: Single_Stat
          name: AE Crafting Tasks
          height: 2
          width: 2
          xPos: 0
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_task" and r._field == "count")
                  |> last()
          decimalPlaces: 0
          suffix: " jobs"
          colors:
            - hex: "#FFD166"
              name: gold
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: CPUs Busy
          height: 2
          width: 2
          xPos: 2
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_cpu" and (r._field == "busy" or r._field == "total"))
                  |> last()
                  |> pivot(rowKey: ["_time", "node", "source"], columnKey: ["_field"], valueColumn: "_value")
                  |> map(fn: (r) => ({r with _value: string(v: int(v: r.busy)) + "/" + string(v: int(v: r.total))}))
          colors:
            - hex: "#4ED8A0"
              name: mint
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: AE Energy Usage
          height: 2
          width: 2
          xPos: 4
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "energy_usage")
                  |> last()
          decimalPlaces: 0
          suffix: " FE/t"
          colors:
            - hex: "#FFB94A"
              name: amber
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Item Storage Used
          height: 2
          width: 2
          xPos: 6
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "item_storage_used")
                  |> last()
          decimalPlaces: 0
          suffix: " bytes"
          colors:
            - hex: "#31C0F6"
              name: pool
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Machines Active
          height: 2
          width: 2
          xPos: 8
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_summary" and r._field == "active_machines")
                  |> last()
          decimalPlaces: 0
          colors:
            - hex: "#4ED8A0"
              name: mint
              type: text
          staticLegend: {}

        - kind: Single_Stat
          name: Machines Total
          height: 2
          width: 2
          xPos: 10
          yPos: 2
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_summary" and r._field == "total_machines")
                  |> last()
          decimalPlaces: 0
          colors:
            - hex: "#A5F3FC"
              name: cyan
              type: text
          staticLegend: {}

        # ── Row 3: Energy flow graph (y=4, height=5) ────────────────────────────

        - kind: Xy
          name: Power Generation vs Consumption
          height: 5
          width: 8
          xPos: 0
          yPos: 4
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == v.detector_generation or r.name == v.detector_consumption)
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> map(fn: (r) => ({r with _field: if r.name == v.detector_generation then "generation" else "consumption"}))
                  |> yield(name: "mean")
          geom: line
          axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: " FE/t"
          staticLegend: {}

        - kind: Xy
          name: Energy Storage (%)
          height: 5
          width: 4
          xPos: 8
          yPos: 4
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_storage" and r._field == "percent")
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          geom: line
          axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: "%"
          staticLegend: {}

        # ── Row 4: AE2 graphs (y=9, height=5) ──────────────────────────────────

        - kind: Xy
          name: AE Items Total
          height: 5
          width: 6
          xPos: 0
          yPos: 9
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "items_total")
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          geom: line
          axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
          staticLegend: {}

        - kind: Xy
          name: AE Energy Usage & Input
          height: 5
          width: 6
          xPos: 6
          yPos: 9
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and (r._field == "energy_usage" or r._field == "energy_input"))
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          geom: line
          axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: " FE/t"
          staticLegend: {}

        # ── Row 5: Crafting queue table + machine type table (y=14, height=5) ──

        - kind: Table
          name: Active Crafting Jobs
          height: 5
          width: 6
          xPos: 0
          yPos: 14
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_job")
                  |> pivot(rowKey: ["_time", "item", "cpu", "node"], columnKey: ["_field"], valueColumn: "_value")
                  |> sort(columns: ["_time"], desc: true)
                  |> limit(n: 50)
                  |> keep(columns: ["_time", "item", "cpu", "quantity", "crafted", "completion"])
          tableOptions:
              verticalTimeAxis: true
          fieldOptions:
            - fieldName: _time
              displayName: Time
              visible: true
            - fieldName: item
              displayName: Item
              visible: true
            - fieldName: cpu
              displayName: CPU
              visible: true
            - fieldName: quantity
              displayName: Qty
              visible: true
            - fieldName: crafted
              displayName: Crafted
              visible: true
            - fieldName: completion
              displayName: Done %
              visible: true
          staticLegend: {}

        - kind: Table
          name: Machine Types
          height: 5
          width: 6
          xPos: 6
          yPos: 14
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_type")
                  |> pivot(rowKey: ["_time", "type", "mod", "node"], columnKey: ["_field"], valueColumn: "_value")
                  |> group()
                  |> sort(columns: ["_time"], desc: true)
                  |> unique(column: "type")
                  |> sort(columns: ["type"])
                  |> keep(columns: ["type", "mod", "node", "total_count", "active_count", "active_percent"])
          tableOptions:
              verticalTimeAxis: false
          fieldOptions:
            - fieldName: type
              displayName: Type
              visible: true
            - fieldName: mod
              displayName: Mod
              visible: true
            - fieldName: node
              displayName: Node
              visible: true
            - fieldName: total_count
              displayName: Total
              visible: true
            - fieldName: active_count
              displayName: Active
              visible: true
            - fieldName: active_percent
              displayName: Active %
              visible: true
          staticLegend: {}

        # ── Row 6: Machine activity grid (y=19, height=6) ──────────────────────
        # Mosaic: one row per machine peripheral name, coloured by "active"/"idle".
        # active=1 → "active" (green tile), active=0 → "idle" (grey tile).
        # Y-axis = name tag; machines sort alphabetically so same-type machines
        # cluster together (eliteCrushing_0, eliteCrushing_1, etc.).
        # Fill column must be a string field — map integer active → string here.

        - kind: Mosaic
          name: Machine Activity Grid
          height: 6
          width: 12
          xPos: 0
          yPos: 19
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_activity" and r._field == "active")
                  |> aggregateWindow(every: v.windowPeriod, fn: last, createEmpty: false)
                  |> map(fn: (r) => ({r with _value: if r._value == 1.0 then "active" else "idle"}))
                  |> keep(columns: ["_time", "_value", "name", "type", "node"])
                  |> group()
          colors:
            - hex: "#4ED8A0"
              name: active
              type: scale
            - hex: "#545667"
              name: idle
              type: scale
          staticLegend: {}
