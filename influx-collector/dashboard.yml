# CC Telemetry — InfluxDB Dashboard Template
#
# SOURCE OF TRUTH: This file. Edit here, then apply with `influx apply`.
# Do NOT edit dashboards in the InfluxDB UI without exporting back here afterwards.
#
# WORKFLOW:
#   Apply (deploy to InfluxDB):
#     influx apply -f mpm-packages/influx-collector/dashboard.yml \
#       --host https://influx.shelfwood.co \
#       --token <operator_token_from_1password> \
#       --org shelfwood
#
#   Export (pull live state back to file):
#     influx export all \
#       --host https://influx.shelfwood.co \
#       --token <operator_token_from_1password> \
#       --org shelfwood \
#       --filter=resourceKind=Variable \
#       --filter=resourceKind=Dashboard \
#       > mpm-packages/influx-collector/dashboard.yml
#     Then strip the auto-generated `metadata.name` slugs and add this header back.
#
# TOKENS:
#   Two tokens exist in InfluxDB (see 1Password vault "Shelfwood", item "influx.shelfwood.co"):
#   - admin_token  : operator-level token — required for `influx apply` and `influx export`
#   - token        : influx-collector write token — used by CC:Tweaked nodes, write-only to mc bucket
#
# VARIABLES (used by dashboard charts):
#   detector_generation  — energy_flow `name` tag value for your generation detector peripheral
#   detector_consumption — energy_flow `name` tag value for your consumption detector peripheral
#   Both are dropdown-selectable in the dashboard UI. Values come from live `energy_flow` tag data.
#
# NODES:
#   cc-58  — AE2 network + energy (me_bridge_1, me_bridge_2) + energy detectors + inventory snapshots
#   cc-49  — Machines only (machine_activity, machine_type, machine_summary)
#
# DASHBOARD LAYOUT (12-column grid):
#   Row 1 (y=0,  h=2): Energy Stored FE | Energy % | Power Generation | Power Consumption | Net Flow | AE Items Total
#   Row 2 (y=2,  h=2): AE Crafting Tasks | CPUs Busy | AE Energy Usage | Item Storage Used | Machines Active | Machines Total
#   Row 3 (y=4,  h=5): Power Generation vs Consumption (line, 8-wide) | Energy Storage % (line, 4-wide)
#   Row 4 (y=9,  h=5): AE Items Total over time (line, 6-wide) | AE Energy Usage & Input (line, 6-wide)
#   Row 5 (y=14, h=5): Active Crafting Jobs (table, 6-wide) | Machine Types (table, 6-wide)
#   Row 6 (y=19, h=12): Machine Activity Grid (mosaic, 12-wide) — per-machine active/idle tiles grouped by type
#
# NOTE: `ae_crafting_job` (Active Crafting Jobs table) only contains rows while AE2 crafting
#       tasks are actively running. The table will be empty when no jobs are in progress.
#
# NOTE: metadata.name values below are arbitrary slugs assigned by InfluxDB on import.
#       They have no semantic meaning. InfluxDB uses `spec.name` as the display name.
#       On re-import, `influx apply` matches by slug and updates in-place (idempotent).

---
apiVersion: influxdata.com/v2alpha1
kind: Variable
metadata:
    name: frosty-bardeen-86b001
spec:
    description: Peripheral name of the energy detector measuring power GENERATION
    language: flux
    name: detector_generation
    query: |-
        import "influxdata/influxdb/schema"
        schema.tagValues(bucket: "mc", tag: "name", predicate: (r) => r._measurement == "energy_flow")
    type: query
---
apiVersion: influxdata.com/v2alpha1
kind: Variable
metadata:
    name: modest-mccarthy-86b003
spec:
    description: Peripheral name of the energy detector measuring power CONSUMPTION
    language: flux
    name: detector_consumption
    query: |-
        import "influxdata/influxdb/schema"
        schema.tagValues(bucket: "mc", tag: "name", predicate: (r) => r._measurement == "energy_flow")
    type: query
---
apiVersion: influxdata.com/v2alpha1
kind: Dashboard
metadata:
    name: compassionate-tesla-06b001
spec:
    description: Minecraft CC:Tweaked telemetry — energy, AE2, crafting, machines
    name: CC Telemetry
    charts:

        # ── Row 1: Energy + AE headline stats (y=0, height=2) ──────────────────

        - colors:
            - hex: '#31C0F6'
              name: pool
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Energy Stored (FE)
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_total" and r._field == "stored_fe")
                  |> last()
          staticLegend: {}
          suffix: ' FE'
          width: 3

        - colors:
            - hex: '#00C9FF'
              name: laser
              type: text
          decimalPlaces: 1
          height: 2
          kind: Single_Stat
          name: Energy %
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_total" and r._field == "percent")
                  |> last()
          staticLegend: {}
          suffix: '%'
          width: 1
          xPos: 3

        - colors:
            - hex: '#4ED8A0'
              name: mint
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Power Generation
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == "energy_detector_0")
                  |> last()
          staticLegend: {}
          suffix: ' FE/t'
          width: 2
          xPos: 4

        - colors:
            - hex: '#F48FB1'
              name: pink
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Power Consumption
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == "energy_detector_1")
                  |> last()
          staticLegend: {}
          suffix: ' FE/t'
          width: 2
          xPos: 6

        - colors:
            - hex: '#FFD166'
              name: gold
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Net Flow
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == "energy_detector_0" or r.name == "energy_detector_1")
                  |> group(columns: ["node", "name"])
                  |> last()
                  |> map(fn: (r) => ({r with _field: if r.name == "energy_detector_0" then "generation" else "consumption"}))
                  |> group(columns: ["node"])
                  |> pivot(rowKey: ["node"], columnKey: ["_field"], valueColumn: "_value")
                  |> map(fn: (r) => ({r with _value: (if exists r.generation then r.generation else 0.0) - (if exists r.consumption then r.consumption else 0.0)}))
          staticLegend: {}
          suffix: ' FE/t'
          width: 2
          xPos: 8

        - colors:
            - hex: '#F48FB1'
              name: pink
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: AE Items Total
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "items_total")
                  |> last()
          staticLegend: {}
          width: 2
          xPos: 10

        # ── Row 2: AE + machine headline stats (y=2, height=2) ─────────────────

        - colors:
            - hex: '#FFD166'
              name: gold
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: AE Crafting Tasks
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_task" and r._field == "count")
                  |> last()
          staticLegend: {}
          suffix: ' jobs'
          width: 2
          yPos: 2

        - colors:
            - hex: '#4ED8A0'
              id: cpu-color
              name: mint
              type: text
          height: 2
          kind: Single_Stat
          name: CPUs Busy
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_cpu" and (r._field == "busy" or r._field == "total"))
                  |> group(columns: ["node", "source", "_field"])
                  |> last()
                  |> pivot(rowKey: ["node", "source"], columnKey: ["_field"], valueColumn: "_value")
                  |> map(fn: (r) => ({r with _value: string(v: int(v: if exists r.busy then r.busy else 0.0)) + "/" + string(v: int(v: if exists r.total then r.total else 0.0))}))
          staticLegend: {}
          width: 2
          xPos: 2
          yPos: 2

        - colors:
            - hex: '#FFB94A'
              name: amber
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: AE Energy Usage
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "energy_usage")
                  |> last()
          staticLegend: {}
          suffix: ' FE/t'
          width: 2
          xPos: 4
          yPos: 2

        - colors:
            - hex: '#31C0F6'
              name: pool
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Item Storage Used
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "item_storage_used")
                  |> last()
          staticLegend: {}
          suffix: ' bytes'
          width: 2
          xPos: 6
          yPos: 2

        - colors:
            - hex: '#4ED8A0'
              name: mint
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Machines Active
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_summary" and r._field == "active_machines")
                  |> last()
          staticLegend: {}
          width: 2
          xPos: 8
          yPos: 2

        - colors:
            - hex: '#A5F3FC'
              name: cyan
              type: text
          decimalPlaces: 0
          height: 2
          kind: Single_Stat
          name: Machines Total
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_summary" and r._field == "total_machines")
                  |> last()
          staticLegend: {}
          width: 2
          xPos: 10
          yPos: 2

        # ── Row 3: Energy graphs (y=4, height=5) ────────────────────────────────

        - axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: ' FE/t'
          geom: line
          height: 5
          kind: Xy
          name: Power Generation vs Consumption
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_flow" and r._field == "rate_fe_t")
                  |> filter(fn: (r) => r.name == "energy_detector_0" or r.name == "energy_detector_1")
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> map(fn: (r) => ({r with _field: if r.name == "energy_detector_0" then "generation" else "consumption"}))
                  |> yield(name: "mean")
          staticLegend: {}
          width: 8
          yPos: 4

        - axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: '%'
          geom: line
          height: 5
          kind: Xy
          name: Energy Storage (%)
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "energy_storage" and r._field == "percent")
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          staticLegend: {}
          width: 4
          xPos: 8
          yPos: 4

        # ── Row 4: AE2 graphs (y=9, height=5) ───────────────────────────────────

        - axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
          geom: line
          height: 5
          kind: Xy
          name: AE Items Total
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and r._field == "items_total")
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          staticLegend: {}
          width: 6
          yPos: 9

        - axes:
            - base: "10"
              name: x
              scale: linear
            - base: "10"
              name: "y"
              scale: linear
              suffix: ' FE/t'
          geom: line
          height: 5
          kind: Xy
          name: AE Energy Usage & Input
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_summary" and (r._field == "energy_usage" or r._field == "energy_input"))
                  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
                  |> yield(name: "mean")
          staticLegend: {}
          width: 6
          xPos: 6
          yPos: 9

        # ── Row 5: Crafting + machine tables (y=14, height=5) ───────────────────

        - fieldOptions:
            - displayName: Time
              fieldName: _time
              visible: true
            - displayName: Item
              fieldName: item
              visible: true
            - displayName: CPU
              fieldName: cpu
              visible: true
            - displayName: Qty
              fieldName: quantity
              visible: true
            - displayName: Crafted
              fieldName: crafted
              visible: true
            - displayName: Done %
              fieldName: completion
              visible: true
          colors:
            - hex: '#31C0F6'
              name: pool
              type: text
          height: 5
          kind: Table
          name: Active Crafting Jobs
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "ae_crafting_job")
                  |> pivot(rowKey: ["_time", "item", "cpu", "node"], columnKey: ["_field"], valueColumn: "_value")
                  |> map(fn: (r) => ({r with
                      item: if exists r.item then string(v: r.item) else "unknown",
                      cpu: if exists r.cpu then string(v: r.cpu) else "unknown",
                      quantity: if exists r.quantity then r.quantity else 0.0,
                      crafted: if exists r.crafted then r.crafted else 0.0,
                      completion: if exists r.completion then r.completion else 0.0
                  }))
                  |> sort(columns: ["_time"], desc: true)
                  |> limit(n: 50)
                  |> keep(columns: ["_time", "item", "cpu", "quantity", "crafted", "completion"])
          staticLegend: {}
          tableOptions:
            verticalTimeAxis: true
          width: 6
          yPos: 14

        - fieldOptions:
            - displayName: Type
              fieldName: type
              visible: true
            - displayName: Mod
              fieldName: mod
              visible: true
            - displayName: Node
              fieldName: node
              visible: true
            - displayName: Total
              fieldName: total_count
              visible: true
            - displayName: Active
              fieldName: active_count
              visible: true
            - displayName: Active %
              fieldName: active_percent
              visible: true
          colors:
            - hex: '#4ED8A0'
              name: mint
              type: text
          height: 5
          kind: Table
          name: Machine Types
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_type")
                  |> filter(fn: (r) => r._field == "total_count" or r._field == "active_count" or r._field == "active_percent")
                  |> filter(fn: (r) => exists r.type and exists r.node)
                  |> filter(fn: (r) => r.type != "me_bridge")
                  |> group(columns: ["node", "mod", "type", "_field"])
                  |> last()
                  |> group()
                  |> pivot(rowKey: ["node", "mod", "type"], columnKey: ["_field"], valueColumn: "_value")
                  |> map(fn: (r) => ({r with
                      type: if exists r.type then string(v: r.type) else "unknown",
                      mod: if exists r.mod then string(v: r.mod) else "unknown",
                      node: if exists r.node then string(v: r.node) else "unknown",
                      total_count: if exists r.total_count then r.total_count else 0.0,
                      active_count: if exists r.active_count then r.active_count else 0.0,
                      active_percent: if exists r.active_percent then r.active_percent else 0.0
                  }))
                  |> sort(columns: ["active_count", "active_percent", "type"], desc: true)
                  |> keep(columns: ["type", "mod", "node", "total_count", "active_count", "active_percent"])
          staticLegend: {}
          width: 6
          xPos: 6
          yPos: 14

        # ── Row 6: Per-machine activity mosaic (y=19, height=12) ───────────────
        # One row per machine, grouped by mod/type/name labels.
        # Every machine gets its own tile stream over time.

        - colors:
            - hex: '#545667'
              name: idle
              type: scale
            - hex: '#4ED8A0'
              name: active
              type: scale
          fillColumns:
            - _value
          height: 12
          kind: Mosaic
          name: Machine Activity Grid
          queries:
            - query: |-
                from(bucket: "mc")
                  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
                  |> filter(fn: (r) => r._measurement == "machine_activity" and r._field == "active")
                  |> filter(fn: (r) => exists r.name and exists r.type and exists r.node)
                  |> filter(fn: (r) => r.type != "me_bridge")
                  -- Use max instead of last so short active bursts are not shown as idle
                  -- when the last sample in a window happens to be 0.
                  |> aggregateWindow(every: v.windowPeriod, fn: max, createEmpty: false)
                  |> map(fn: (r) => ({r with
                      mod: if exists r.mod then string(v: r.mod) else "unknown",
                      type: string(v: r.type),
                      name: string(v: r.name),
                      node: string(v: r.node),
                      _value: if r._value > 0.0 then 1.0 else 0.0
                  }))
                  |> keep(columns: ["_time", "_value", "name", "type", "mod", "node"])
          staticLegend: {}
          width: 12
          xColumn: _time
          yAxisLabel: Machines
          yLabelColumnSeparator: ' · '
          yLabelColumns:
            - type
            - name
          ySeriesColumns:
            - mod
            - type
            - name
            - node
          yPos: 19
